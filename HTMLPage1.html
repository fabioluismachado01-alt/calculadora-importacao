<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Importação Simplificada + NCM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --navy: #020617;
      --navy-light: #0f172a;
      --gold: #eab308;
      --gold-light: #facc15;
      --bg: #020617;
      --card-bg: #0b1220;
      --border: #1e293b;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #fca5a5;
      --radius: 14px;
    }

    * {
      box-sizing: border-box;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      border-bottom: 1px solid var(--border);
      padding: 14px 18px;
      background: rgba(2, 6, 23, 0.92);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      font-size: 18px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }

    header .dot {
      width: 10px;
      height: 10px;
      background: var(--gold);
      border-radius: 50%;
      box-shadow: 0 0 14px rgba(234, 179, 8, 0.9);
    }

    #cotacaoInfo {
      font-size: 12px;
      color: var(--text-muted);
      text-align: right;
    }

    main {
      max-width: 1000px;
      margin: 24px auto;
      padding: 0 16px 50px;
      width: 100%;
    }

    .card {
      background: linear-gradient(145deg, #111827 0%, #020617 70%);
      border: 1px solid var(--border);
      padding: 20px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.45);
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
      font-weight: 600;
    }

    .grid {
      display: grid;
      gap: 14px;
    }

    @media (min-width: 640px) {
      .grid-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .grid-3 {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    label {
      font-size: 13px;
      margin-bottom: 6px;
      display: block;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--gold);
      box-shadow: 0 0 0 1px rgba(234, 179, 8, 0.5);
    }

    textarea {
      resize: vertical;
    }

    button {
      background: linear-gradient(90deg, var(--gold-light), var(--gold));
      color: #0f172a;
      border: none;
      padding: 10px 22px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.15s;
      box-shadow: 0 8px 20px rgba(234, 179, 8, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 32px rgba(234, 179, 8, 0.45);
    }

    .danger {
      color: var(--danger);
      font-size: 13px;
      margin-top: 8px;
    }

    .success {
      color: #bbf7d0;
      font-size: 13px;
      margin-top: 8px;
    }

    .result {
      background: rgba(250, 204, 21, 0.1);
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid rgba(250, 204, 21, 0.3);
    }

    .result-label {
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .result-value {
      font-weight: 700;
      color: #facc15;
    }

    .muted {
      font-size: 12px;
      color: var(--text-muted);
    }
  </style>
</head>

<body>

<header>
  <h1><span class="dot"></span> Calculadora de Importação – Modo Simplificado</h1>
  <div id="cotacaoInfo">Cotação: carregando...</div>
</header>

<main>

  <!-- 🔹 SEÇÃO NCM + TRATAMENTOS -->
  <div class="card">
    <h2>NCM & Tratamentos Administrativos</h2>

    <div class="grid grid-2">
      <div>
        <label for="ncmCodigo">NCM (8 dígitos)</label>
        <input type="text" id="ncmCodigo" maxlength="8" placeholder="ex.: 95030089">
      </div>

      <div style="display:flex;align-items:flex-end;">
        <button type="button" id="consultarNcmBtn">Consultar NCM na Receita</button>
      </div>
    </div>

    <br>

    <div class="grid grid-2">
      <div>
        <label>Permite importação simplificada?</label>
        <select id="ncmSimplificada">
          <option value="">Selecione...</option>
          <option value="sim">Sim</option>
          <option value="nao">Não</option>
          <option value="depende">Depende</option>
        </select>
      </div>

      <div>
        <label>Tributos especiais</label>
        <label><input type="checkbox" id="ncmCide"> CIDE</label><br>
        <label><input type="checkbox" id="ncmAntidumping"> Antidumping</label><br>
        <label><input type="checkbox" id="ncmComp"> Medidas compensatórias</label>
      </div>
    </div>

    <br>

    <label>Órgãos anuentes</label>
    <div class="grid grid-3" style="font-size:14px;">
      <label><input type="checkbox" class="ncm-orgao" value="anvisa"> Anvisa</label>
      <label><input type="checkbox" class="ncm-orgao" value="inmetro"> Inmetro</label>
      <label><input type="checkbox" class="ncm-orgao" value="mapa"> MAPA</label>
      <label><input type="checkbox" class="ncm-orgao" value="exercito"> Exército</label>
      <label><input type="checkbox" class="ncm-orgao" value="ibama"> Ibama</label>
      <label><input type="checkbox" class="ncm-orgao" value="anatel"> Anatel</label>
      <label><input type="checkbox" class="ncm-orgao" value="outros"> Outros</label>
    </div>

    <br>

    <label>O produto possui bateria?</label>
    <div style="display:flex; gap:16px; font-size:14px;">
      <label><input type="radio" name="produtoBateria" value="nao" checked> Não</label>
      <label><input type="radio" name="produtoBateria" value="sim"> Sim</label>
    </div>

    <br>

    <label>O produto é Bluetooth ou Wi-Fi?</label>
    <div style="display:flex; gap:16px; font-size:14px;">
      <label><input type="radio" name="produtoRadio" value="nao" checked> Não</label>
      <label><input type="radio" name="produtoRadio" value="sim"> Sim</label>
    </div>

    <br>

    <label>Observações / Anotações</label>
    <textarea id="ncmObs" rows="4" placeholder="Use este espaço para anotar detalhes relevantes do NCM, descrição da mercadoria, exceções, etc."></textarea>

    <div id="ncmAlerta" class="danger"></div>
  </div>

  <!-- 🔹 SEÇÃO CÂMBIO -->
  <div class="card">
    <h2>Câmbio</h2>

    <label><input type="checkbox" id="cotacaoAuto" checked> Usar cotação automática</label>

    <label>Cotação do dólar (USD → BRL)</label>
    <input type="number" id="cotacao" step="0.0001" disabled>
    <p class="muted">Se preferir, desmarque a opção acima para editar a cotação manualmente.</p>
  </div>

  <!-- 🔹 PRODUTO -->
  <div class="card">
    <h2>Produto & Custos (USD)</h2>

    <div class="grid grid-2">

      <div>
        <label>Nome do produto</label>
        <input type="text" id="produtoNome" placeholder="Ex.: Fone Bluetooth">
      </div>

      <div>
        <label>Custo unitário (USD)</label>
        <input type="number" id="custoUSD" step="0.01" value="0.24">
      </div>

      <div>
        <label>Quantidade</label>
        <input type="number" id="quantidade" value="1250">
      </div>

      <div>
        <label>Frete internacional (USD)</label>
        <input type="number" id="freteUSD" step="0.01" value="250">
      </div>

      <div>
        <label>Seguro internacional (USD)</label>
        <input type="number" id="seguroUSD" step="0.01" value="0">
      </div>
    </div>
  </div>

  <!-- 🔹 IMPOSTOS -->
  <div class="card">
    <h2>Impostos Simplificados</h2>

    <div class="grid grid-2">
      <div>
        <label>II – Imposto de Importação (%)</label>
        <input type="number" id="iiPercent" value="60">
      </div>

      <div>
        <label>ICMS do estado (%)</label>
        <input type="number" id="icmsPercent" value="18">
      </div>
    </div>
  </div>

  <!-- 🔹 BOTÃO CALCULAR IMPORTAÇÃO -->
  <div class="card" style="text-align:center;">
    <button id="calcularBtn">Calcular custo de importação</button>
  </div>

  <!-- 🔹 RESULTADO IMPORTAÇÃO -->
  <div class="card result" id="resultadoCard" style="display:none;">
    <h2>Resultado da Importação</h2>

    <div class="result-label">
      Valor dos produtos (BRL):
      <span class="result-value" id="resProdutos"></span>
    </div>
    <div class="result-label">
      Valor do frete + seguro (BRL):
      <span class="result-value" id="resFreteSeguro"></span>
    </div>
    <div class="result-label">
      Valor dos impostos (II + ICMS) (BRL):
      <span class="result-value" id="resImpostos"></span>
    </div>
    <div class="result-label">
      Taxa courier (mín. 18,8 USD ou 2% da base) (BRL):
      <span class="result-value" id="resCourier"></span>
    </div>

    <hr>

    <div class="result-label">
      Custo total do lote:
      <span class="result-value" id="resultadoTotal"></span>
    </div>

    <div class="result-label">
      Custo unitário do produto:
      <span class="result-value" id="resultadoUnitario"></span>
    </div>

    <p class="muted" id="resResumoBase"></p>
  </div>

  <!-- 🔹 SIMULAR VIABILIDADE DE VENDA -->
  <div class="card" id="viabilidadeCard" style="display:none;">
    <h2>Simular Viabilidade de Venda</h2>
    <p class="muted">
      Preencha os campos em verde (como na planilha). O custo do produto já vem do cálculo de importação,
      mas você pode ajustar manualmente.
    </p>

    <div class="grid grid-2">
      <div>
        <label>Valor da venda (R$)</label>
        <input type="number" id="vVenda" step="0.01" value="19.90">
      </div>

      <div>
        <label>Tarifa fixa do marketplace (R$)</label>
        <input type="number" id="vTarifaFixa" step="0.01" value="6.00">
      </div>

      <div>
        <label>Tarifa anúncio (%)</label>
        <input type="number" id="vTarifaAnuncioPercent" step="0.01" value="13.00">
      </div>

      <div>
        <label>Impostos sobre venda (%)</label>
        <input type="number" id="vImpostosPercent" step="0.01" value="4.00">
      </div>

      <div>
        <label>Embalagem (R$)</label>
        <input type="number" id="vEmbalagem" step="0.01" value="0.50">
      </div>

      <div>
        <label>Custo do produto (R$)</label>
        <input type="number" id="vCustoProduto" step="0.01">
      </div>
    </div>

    <div style="text-align:center;margin-top:14px;">
      <button id="btnCalcVenda" type="button">Calcular viabilidade de venda</button>
    </div>

    <div class="result" id="viabResultado" style="margin-top:14px; display:none;">
      <div class="result-label">
        Margem contribuição (por unidade):
        <span class="result-value" id="viabMargem"></span>
      </div>
      <div class="result-label">
        Margem ROI:
        <span class="result-value" id="viabROI"></span>
      </div>
      <div class="result-label">
        Investimento × Retorno (lote):
        <span class="result-value" id="viabMontao"></span>
      </div>

      <div id="viabAlerta"></div>
    </div>
  </div>

</main>

<footer>
  Desenvolvido para fins didáticos. Atualize sempre as alíquotas conforme sua operação.
</footer>

<script>
  /* ================================
       1) COTAÇÃO AUTOMÁTICA
  =================================*/
  const cotacaoTexto = document.getElementById("cotacaoInfo");
  const cotacaoInput = document.getElementById("cotacao");
  const cotacaoAuto = document.getElementById("cotacaoAuto");

  async function buscarCotacao() {
    try {
      cotacaoTexto.textContent = "Cotação: carregando...";
      const res = await fetch("https://economia.awesomeapi.com.br/json/last/USD-BRL");
      const data = await res.json();
      const rate = parseFloat(data.USDBRL.bid);
      if (!isNaN(rate)) {
        cotacaoInput.value = rate.toFixed(4);
        cotacaoTexto.textContent = "Cotação: R$ " + rate.toFixed(4);
      } else {
        cotacaoTexto.textContent = "Cotação: erro";
      }
    } catch (e) {
      cotacaoTexto.textContent = "Cotação: erro";
    }
  }

  buscarCotacao();
  setInterval(buscarCotacao, 60000);

  cotacaoAuto.addEventListener("change", () => {
    cotacaoInput.disabled = cotacaoAuto.checked;
    if (cotacaoAuto.checked) buscarCotacao();
  });

  /* ================================
       2) NCM ALERTAS + OBSERVAÇÕES AUTOMÁTICAS
  =================================*/
  const ncmSimplificada = document.getElementById("ncmSimplificada");
  const ncmCide = document.getElementById("ncmCide");
  const ncmAntidumping = document.getElementById("ncmAntidumping");
  const ncmComp = document.getElementById("ncmComp");
  const ncmAlerta = document.getElementById("ncmAlerta");
  const ncmObs = document.getElementById("ncmObs");
  const orgaosCheckboxes = document.querySelectorAll(".ncm-orgao");
  const bateriaRadios = document.querySelectorAll('input[name="produtoBateria"]');
  const radioRadios = document.querySelectorAll('input[name="produtoRadio"]');

  let manualObs = "";
  let updatingObs = false;

  // guarda parte manual digitada pelo aluno
  ncmObs.addEventListener("input", () => {
    if (updatingObs) return;
    const marker = "\n\n--- Observações automáticas ---";
    const texto = ncmObs.value;
    const idx = texto.indexOf(marker);
    manualObs = idx >= 0 ? texto.slice(0, idx) : texto;
  });

  function atualizarAlertasNCM() {
    const msgs = [];

    if (ncmSimplificada.value === "nao")
      msgs.push("⚠️ Este NCM foi marcado como não elegível à importação simplificada.");

    if (ncmAntidumping.checked)
      msgs.push("⚠️ NCM com antidumping: revise viabilidade, pode inviabilizar a importação.");

    ncmAlerta.textContent = msgs.join(" | ");
    atualizarObsAutomaticas();
  }

  function atualizarObsAutomaticas() {
    const autoMsgs = [];

    // Órgãos anuentes
    const selecionados = Array.from(orgaosCheckboxes)
      .filter(c => c.checked)
      .map(c => {
        const mapa = {
          anvisa: "Anvisa",
          inmetro: "Inmetro",
          mapa: "MAPA",
          exercito: "Exército",
          ibama: "Ibama",
          anatel: "Anatel",
          outros: "outros órgãos competentes"
        };
        return mapa[c.value] || c.value;
      });

    if (selecionados.length > 0) {
      const lista = selecionados.join(", ");
      autoMsgs.push(
        "Este NCM possui tratamento administrativo com órgão(s) anuente(s): " + lista +
        ". Em regra, mercadorias sujeitas à anuência desses órgãos não são enquadradas como remessa simplificada. " +
        "Considere planejar a operação via despacho formal e providenciar previamente as certificações, licenças e registros correspondentes antes de importar."
      );
      if (!ncmSimplificada.value) {
        ncmSimplificada.value = "nao";
      }
    }

    // CIDE / Antidumping / Medidas compensatórias
    if (ncmCide.checked || ncmAntidumping.checked || ncmComp.checked) {
      autoMsgs.push(
        "Foi sinalizada a existência de CIDE, antidumping e/ou medidas compensatórias para este NCM. " +
        "Revise com atenção as alíquotas e condições no Sítio de Apoio ao Importador (Portal Único/Siscomex) e valide com seu despachante ou assessor aduaneiro " +
        "se a operação é permitida e permanece economicamente viável."
      );
    }

    // Produto com bateria
    const bateriaValor = Array.from(bateriaRadios).find(r => r.checked)?.value;
    if (bateriaValor === "sim") {
      autoMsgs.push(
        "Produto com bateria: solicite ao fornecedor a ficha de segurança MSDS (Material Safety Data Sheet) e confirme com o courier/transportadora " +
        "as exigências específicas para transporte, embalagem e documentação de artigos que contenham baterias."
      );
    }

    // Produto com Bluetooth/Wi-Fi
    const radioValor = Array.from(radioRadios).find(r => r.checked)?.value;
    const anatelCheckbox = Array.from(orgaosCheckboxes).find(c => c.value === "anatel");
    if (radioValor === "sim") {
      if (anatelCheckbox && !anatelCheckbox.checked) {
        anatelCheckbox.checked = true; // força Anatel como órgão anuente
      }
      autoMsgs.push(
        "Produto com funcionalidade de radiocomunicação (Bluetooth e/ou Wi-Fi): em regra exige homologação e anuência da Anatel " +
        "para fins de importação e posterior comercialização no Brasil. Consulte a regulamentação específica no portal da Anatel " +
        "e, em caso de dúvida, alinhe o procedimento com seu despachante aduaneiro antes de avançar com a operação."
      );
    }

    const marker = "\n\n--- Observações automáticas ---\n";
    updatingObs = true;

    if (autoMsgs.length > 0) {
      if (manualObs.trim().length > 0) {
        ncmObs.value = manualObs + marker + autoMsgs.join("\n\n");
      } else {
        ncmObs.value = "--- Observações automáticas ---\n" + autoMsgs.join("\n\n");
      }
    } else {
      ncmObs.value = manualObs;
    }

    updatingObs = false;
  }

  ncmSimplificada.addEventListener("change", atualizarAlertasNCM);
  ncmAntidumping.addEventListener("change", atualizarAlertasNCM);
  ncmCide.addEventListener("change", atualizarObsAutomaticas);
  ncmComp.addEventListener("change", atualizarObsAutomaticas);
  orgaosCheckboxes.forEach(c => c.addEventListener("change", atualizarObsAutomaticas));
  bateriaRadios.forEach(r => r.addEventListener("change", atualizarObsAutomaticas));
  radioRadios.forEach(r => r.addEventListener("change", atualizarObsAutomaticas));

  document.getElementById("consultarNcmBtn")
    .addEventListener("click", function () {
      window.open("https://www4.receita.fazenda.gov.br/simulador/", "_blank");
    });

  /* ================================
       3) FUNÇÃO AUXILIAR
  =================================*/
  function brl(v) {
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  /* ================================
       4) CÁLCULO IMPORTAÇÃO
  =================================*/
  document.getElementById("calcularBtn").addEventListener("click", () => {
    const cotacao = parseFloat(cotacaoInput.value);
    const custoUSD = parseFloat(document.getElementById("custoUSD").value);
    const qtd = parseInt(document.getElementById("quantidade").value);
    const freteUSD = parseFloat(document.getElementById("freteUSD").value);
    const seguroUSD = parseFloat(document.getElementById("seguroUSD").value);
    const iiPercent = parseFloat(document.getElementById("iiPercent").value) / 100;
    const icmsPercent = parseFloat(document.getElementById("icmsPercent").value) / 100;

    if (!cotacao || cotacao <= 0 || !qtd || qtd <= 0) {
      alert("Informe uma cotação válida e uma quantidade maior que zero.");
      return;
    }

    // Produtos / Frete / Seguro em USD
    const valorProdutosUSD = custoUSD * qtd;
    const valorFreteSeguroUSD = freteUSD + seguroUSD;

    // Converte para BRL
    const valorProdutosBRL = valorProdutosUSD * cotacao;
    const valorFreteSeguroBRL = valorFreteSeguroUSD * cotacao;

    // Valor aduaneiro (base II) em BRL
    const valorAduaneiroBRL = valorProdutosBRL + valorFreteSeguroBRL;

    // Impostos
    const valorII = valorAduaneiroBRL * iiPercent;
    // (podemos refinar depois fórmula exata do ICMS, se quiser)
    const valorICMS = valorAduaneiroBRL * icmsPercent;
    const valorImpostosBRL = valorII + valorICMS;

    // === COURIER (regra da planilha) ===
    const baseCourierBRL = valorProdutosBRL + valorFreteSeguroBRL + valorImpostosBRL;
    const courier2pctBRL = baseCourierBRL * 0.02;
    const courierMinBRL = 18.8 * cotacao;
    const courierBRL = courier2pctBRL < courierMinBRL ? courierMinBRL : courier2pctBRL;

    const totalBRL = baseCourierBRL + courierBRL;
    const unitarioBRL = totalBRL / qtd;

    document.getElementById("resProdutos").textContent = brl(valorProdutosBRL);
    document.getElementById("resFreteSeguro").textContent = brl(valorFreteSeguroBRL);
    document.getElementById("resImpostos").textContent = brl(valorImpostosBRL);
    document.getElementById("resCourier").textContent = brl(courierBRL);

    document.getElementById("resultadoTotal").textContent = brl(totalBRL);
    document.getElementById("resultadoUnitario").textContent = brl(unitarioBRL);

    document.getElementById("resResumoBase").textContent =
      "Base courier = Produtos + Frete/Seguro + Impostos = " +
      brl(baseCourierBRL) +
      ". Courier calculado como maior valor entre 2% da base (" +
      brl(courier2pctBRL) +
      ") e 18,8 × cotação (" +
      brl(courierMinBRL) +
      ").";

    document.getElementById("resultadoCard").style.display = "block";

    document.getElementById("vCustoProduto").value = unitarioBRL.toFixed(2);
    document.getElementById("viabilidadeCard").style.display = "block";
  });

  /* ================================
       5) CÁLCULO VIABILIDADE DE VENDA
  =================================*/
  const btnCalcVenda = document.getElementById("btnCalcVenda");
  const viabResultado = document.getElementById("viabResultado");
  const viabMargem = document.getElementById("viabMargem");
  const viabROI = document.getElementById("viabROI");
  const viabMontao = document.getElementById("viabMontao");
  const viabAlerta = document.getElementById("viabAlerta");

  btnCalcVenda.addEventListener("click", () => {
    const venda = parseFloat(document.getElementById("vVenda").value);
    const tarifaFixa = parseFloat(document.getElementById("vTarifaFixa").value);
    const tarifaAnuncioPercent = parseFloat(document.getElementById("vTarifaAnuncioPercent").value) / 100;
    const impostosPercent = parseFloat(document.getElementById("vImpostosPercent").value) / 100;
    const embalagem = parseFloat(document.getElementById("vEmbalagem").value);
    const custoProduto = parseFloat(document.getElementById("vCustoProduto").value);
    const qtd = parseInt(document.getElementById("quantidade").value) || 0;

    if (!venda || !custoProduto) {
      alert("Informe pelo menos o valor da venda e o custo do produto.");
      return;
    }

    const tarifaAnuncioValor = venda * tarifaAnuncioPercent;
    const impostosValor = venda * impostosPercent;

    const margemContrib = venda
      - tarifaFixa
      - tarifaAnuncioValor
      - impostosValor
      - embalagem
      - custoProduto;

    const roiDecimal = custoProduto > 0 ? margemContrib / custoProduto : 0;
    const roiPercent = roiDecimal * 100;
    const montao = margemContrib * qtd;

    viabMargem.textContent = brl(margemContrib);
    viabROI.textContent = roiPercent.toFixed(0) + "%";
    viabMontao.textContent = brl(montao);

    if (margemContrib <= 0) {
      viabAlerta.className = "danger";
      viabAlerta.textContent = "⚠️ Margem negativa ou zero: este cenário não compensa trazer o produto nessas condições.";
    } else if (roiPercent < 30) {
      viabAlerta.className = "danger";
      viabAlerta.textContent = "⚠️ Margem baixa: avalie se o risco/capital investido compensa.";
    } else {
      viabAlerta.className = "success";
      viabAlerta.textContent = "✅ Cenário com boa margem. Ainda assim, considere volume de vendas, concorrência e riscos comerciais.";
    }

    viabResultado.style.display = "block";
    viabResultado.scrollIntoView({ behavior: "smooth", block: "center" });
  });
</script>

</body>
</html>
