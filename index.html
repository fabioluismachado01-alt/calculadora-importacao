<section id="rateio-simplificada" class="card" style="margin-top: 2rem;">
  <h2>Rateio entre Produtos – Importação Simplificada</h2>
  <p>Se você está trazendo mais de um produto no mesmo lote, preencha os dados abaixo para simular o rateio proporcional dos custos:</p>

  <!-- Campo oculto para receber o total de impostos da simplificada -->
  <input type="hidden" id="total-impostos" value="0">

  <div id="produtos-container" style="margin-bottom: 1rem;"></div>

  <div style="margin-bottom: 1rem;">
    <button onclick="adicionarProduto()">+ Adicionar Produto</button>
    <button onclick="calcularRateio()">Calcular Rateio</button>
  </div>

  <div id="resultado-rateio" style="margin-top: 1rem;"></div>

  <style>
    #rateio-simplificada input {
      padding: 6px;
      margin: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #rateio-simplificada table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    #rateio-simplificada th, #rateio-simplificada td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }

    #rateio-simplificada th {
      background-color: #002b5c;
      color: gold;
    }

    #rateio-simplificada tr:nth-child(even) {
      background-color: #f9f9f9;
    }
  </style>

  <script>
    const produtosContainer = document.getElementById('produtos-container');

    function adicionarProduto() {
      const index = produtosContainer.children.length;
      const div = document.createElement('div');
      div.innerHTML = `
        <input type="text" placeholder="Nome" id="nome-${index}">
        <input type="number" placeholder="Qtd" id="qtd-${index}" min="1">
        <input type="number" placeholder="Valor unit. USD" id="valor-${index}" step="0.01" min="0">
        <input type="number" placeholder="Peso (kg)" id="peso-${index}" step="0.01" min="0">
      `;
      produtosContainer.appendChild(div);
    }

    function calcularRateio() {
      const cotacao = parseFloat(document.getElementById('cotacao-usd')?.value || 5.0);
      const frete = parseFloat(document.getElementById('frete-usd')?.value || 0);
      const seguro = parseFloat(document.getElementById('seguro-usd')?.value || 0);
      const impostos = parseFloat(document.getElementById('total-impostos')?.value || 0);

      const produtos = [];
      const total = produtosContainer.children.length;

      for (let i = 0; i < total; i++) {
        const nome = document.getElementById(`nome-${i}`).value || `Produto ${i+1}`;
        const qtd = parseFloat(document.getElementById(`qtd-${i}`).value || 0);
        const valor = parseFloat(document.getElementById(`valor-${i}`).value || 0);
        const peso = parseFloat(document.getElementById(`peso-${i}`).value || 0);
        if (qtd > 0 && valor >= 0 && peso >= 0) {
          produtos.push({ nome, qtd, valor, peso });
        }
      }

      const totalUSD = produtos.reduce((sum, p) => sum + p.qtd * p.valor, 0);
      const totalPeso = produtos.reduce((sum, p) => sum + (p.qtd * p.peso), 0);

      let html = `<table><tr>
        <th>Produto</th><th>Qtd</th><th>USD</th><th>Peso</th>
        <th>Frete/Seguro (R$)</th><th>Impostos (R$)</th>
        <th>Total (R$)</th><th>Unit. (R$)</th>
      </tr>`;

      produtos.forEach(p => {
        const subtotalUSD = p.qtd * p.valor;
        const pesoTotal = p.qtd * p.peso;
        const freteRateado = ((subtotalUSD / totalUSD) * (frete + seguro)) * cotacao;
        const impostosRateado = (pesoTotal / totalPeso) * impostos;
        const custoBRL = (subtotalUSD * cotacao) + freteRateado + impostosRateado;
        const unitarioBRL = custoBRL / p.qtd;

        html += `<tr>
          <td>${p.nome}</td>
          <td>${p.qtd}</td>
          <td>$${subtotalUSD.toFixed(2)}</td>
          <td>${pesoTotal.toFixed(2)}kg</td>
          <td>R$ ${freteRateado.toFixed(2)}</td>
          <td>R$ ${impostosRateado.toFixed(2)}</td>
          <td>R$ ${custoBRL.toFixed(2)}</td>
          <td>R$ ${unitarioBRL.toFixed(2)}</td>
        </tr>`;
      });

      html += '</table>';
      document.getElementById('resultado-rateio').innerHTML = html;
    }
  </script>
</section>
